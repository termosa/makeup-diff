<!DOCTYPE html>
<html>
  <head>
    <title>MakeUp</title>
    <link rel="stylesheet" href="style.css" />
    <meta charset="utf8"/>
  </head>
  <body>

    <form id="compare-form">
      <h1>Compare MakeUp products</h1>
      <label>Copy products links to the input below (8 is a maximum):
        <textarea id="links" placeholder="https://makeup.com.ua/product/11180/
https://makeup.com.ua/product/2035/"></textarea>
      </label>
      <input type="submit" value="Compare" />
      <div id="share">
        Share it with friends: <b id="share-link"></b>
      </div>
      <div id="result"></div>
    </form>

    <script>
      const $form = document.querySelector('#compare-form')
      const $output = document.querySelector('#result')
      const $input = document.querySelector('#links')
      const $share = document.querySelector('#share-link')

      $share.innerText = location.href

      function load(ids) {
        return fetch('/api/collect.js?products=' + ids.join(','))
          .then(response => response.json())
      }

      function isDifferent(items, getProperty) {
        if (items.length < 2) return true;
        for (let i = items.length - 1; i--;) {
          if (items[i] !== items[i + 1])
            return true
        }
        return false
      }

      function renderRow(title, items, template) {
        const diff = isDifferent(items)
        return '<tr class="' + (diff ? 'diff' : 'same') + '"><th>' + title + '</th>' +
          items.map(function (value) {
            value = value || ''
            return '<td>' + (template ? template(value) : value) + '</td>'
          }).join('') + '</tr>'
      }

      function collectProductsProperties(products) {
        return [...new Set(products.reduce((props, product) => props.concat(Object.keys(product.properties)), []))]
      }

      function renderTable(products) {
        $output.innerHTML = '<table>' +
          renderRow('', products.map(p => '<b>' + p.name + '</b>')) +
          renderRow('', products.map(p => '<img src="' + p.imageUri + '"/>')) +
          renderRow('Category', products.map(p => p.category)) +
          renderRow('Price', products.map(p => (p.price || '?') + ' uah')) +
          renderRow('Rating/Reviews', products.map(p => (p.rating || 0) + ' / ' + (p.reviews || 0))) +
          renderRow('Reviews', products.map(p => p.reviews || '0')) +
          collectProductsProperties(products)
            .map(property => renderRow(
              property,
              products.map(p => p.properties[property] || '')
            ))
            .join('')
        '</table>'
      }

      function compare(links) {
        $output.innerText = 'Loading...'
        const ids = [...new Set(links.map(link => link.match(/\/(\d+)/)[1]))].slice(0, 8)
        location.hash = ids.join(',')
        $share.innerText = location.href
        load(ids).then(function (products) {
          renderTable(products.filter(p => !p.error))
        })
      }

      function selectLink() {
        if (document.body.createTextRange) {
          const range = document.body.createTextRange();
          range.moveToElementText($share);
          range.select();
        } else if (window.getSelection) {
          const selection = window.getSelection();
          const range = document.createRange();
          range.selectNodeContents($share);
          selection.removeAllRanges();
          selection.addRange(range);
        }
      }

      $form.addEventListener('submit', function (event) {
        event.preventDefault()
        const links = $input.value.match(/https\:\/\/makeup.com.ua\/product\/\d+/g)
        if (!links || !links.length) {
          alert('Enter links first')
          return
        }
        compare(links)
        selectLink()
      })

      if (location.hash && location.hash.match(/^#(\d+,)*\d+$/)) {
        const links = location.hash.slice(1).split(',')
          .map(id => `https://makeup.com.ua/product/${id}/`)
        compare(links);
        $input.value = links.join('\n')
      }

      $share.parentElement.addEventListener('click', selectLink)
    </script>

  </body>
</html>
